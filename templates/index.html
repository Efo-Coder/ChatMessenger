<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="author" content="Efrahim Haser">
    <title>Chat Messenger</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<audio id="send-sound" src="{{ url_for('static', filename='sounds/message.mp3') }}"></audio>

<body>
    <!-- HEADER -->
    <div class="header-chat">

        <div class="header-left">
            <img src="{{ url_for('static', filename='images/messenger.png') }}" alt="Messenger Icon"
                class="header-icon">
            <h3 class="header-title">Chat Messenger</h3>
        </div>

        <div class="d-flex align-items-center">
            <button class="btn btn-outline-light me-2 dark-mode-btn" onclick="toggleDarkMode()">🌓</button>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-danger logout-btn">Logout</a>
        </div>
        
    </div>

    <!-- NACHRICHTENBEREICH -->
    <div class="chat-container" id="chat-container">
        {% set previous_user = None %}
        {% for message in messages %}
            {% set show_user = (message.user != previous_user) %}
            {% set previous_user = message.user %}

            <div class="d-flex {{ 'justify-content-end' if message.user == current_user else 'justify-content-start' }} mt-4">
                <div>
                    {% if show_user %}
                        <div class="small text-muted mb-1 {{ 'text-end' if message.user == current_user else 'text-start' }}">
                            <span class="username">{{ message.user }}</span>
                        </div>
                    {% endif %}
                    <div class="card {{ 'bg-primary text-white' if message.user == current_user else 'bg-light' }}">
                        <div class="card-body {{ 'text-end' if message.user == current_user else 'text-start' }}">
                            {{ message.content }}
                        </div>
                        <div class="message-time">{{ message.created_at.strftime("%H:%M") }}</div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- EINGABEFELD -->
    <div class="input-form-container">

        <form class="input-group" action="" method="POST" id="message-form">
            <input type="text" name="content" class="form-control" id="message-input" placeholder="Enter message..."
                autocomplete="off">

            <!-- Senden-Button mit eigenem Namen -->
            <button class="btn btn-outline-secondary send-btn" type="submit" name="action" value="send">Send</button>

            <!-- Clear-Button mit eigenem Namen -->
            <button class="btn btn-outline-danger clear-btn" type="submit" name="action" value="clear">Clear</button>
        </form>

    </div>

    <script>
    // ========== AUTOLOAD & DARK MODE INITIALISIERUNG ==========
    window.onload = function () {
        const chatContainer = document.getElementById("chat-container");
        const inputField = document.getElementById("message-input");

        if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        if (inputField) {
            inputField.focus();
        }

        // Dark Mode beim Laden aktivieren, wenn gespeichert
        if (localStorage.getItem("dark-mode") === "true") {
            document.body.classList.add("dark-mode");
        }
    };

    // ========== DARK MODE TOGGLE ==========
    function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
        localStorage.setItem("dark-mode", document.body.classList.contains("dark-mode"));
    }

    // ========== SENDEN & SOUNDEFFEKT & ENTER-KEY ==========
    const form = document.getElementById("message-form");
    const input = document.getElementById("message-input");
    const sound = document.getElementById("send-sound");

    if (form && input && sound) {
        form.addEventListener("submit", function () {
            if (sound && typeof sound.play === "function") {
                sound.play().catch((e) => {
                    console.warn("Sound konnte nicht abgespielt werden:", e);
                });
            }

            setTimeout(() => {
                input.focus();
            }, 100);
        });

        input.addEventListener("keypress", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();

                // ⬅️ Dieses Hidden-Input-Feld wird angelegt, um die action zu übergeben
                let hidden = document.createElement("input");
                hidden.type = "hidden";
                hidden.name = "action";
                hidden.value = "send";
                form.appendChild(hidden);

                form.requestSubmit(); // Enter gedrückt → Senden
            }
        });
    }
    </script>

</body>

</html>