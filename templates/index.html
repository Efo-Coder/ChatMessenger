<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="author" content="Efrahim Haser">
    <title>Chat Messenger</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <!-- HEADER -->
    <div class="header">

        <div class="header-left">
            <img src="{{ url_for('static', filename='images/messenger.png') }}" alt="Messenger Icon"
                class="header-icon">
            <h3 class="header-title">Chat Messenger</h3>
        </div>

        <div class="d-flex align-items-center">
            <button class="btn btn-outline-light me-2 dark-mode-btn" onclick="toggleDarkMode()">ðŸŒ“</button>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-danger logout-btn">Logout</a>
        </div>
        
    </div>

    <!-- NACHRICHTENBEREICH -->
    <div class="chat-container" id="chat-container">
        {% set previous_user = None %}
        {% for message in messages %}
            {% set show_user = (message.user != previous_user) %}
            {% set previous_user = message.user %}

            <div class="d-flex {{ 'justify-content-end' if message.user == current_user else 'justify-content-start' }} mt-4">
                <div>
                    {% if show_user %}
                        <div class="small text-muted mb-1 {{ 'text-end' if message.user == current_user else 'text-start' }}">
                            {{ message.user }}
                        </div>
                    {% endif %}
                    <div class="card {{ 'bg-primary text-white' if message.user == current_user else 'bg-light' }}">
                        <div class="card-body {{ 'text-end' if message.user == current_user else 'text-start' }}">
                            {{ message.content }}
                        </div>
                        <div class="message-time">{{ message.created_at.strftime("%H:%M") }}</div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- EINGABEFELD -->
    <div class="input-form-container">

        <form class="input-group" action="" method="POST" id="message-form">
            <input type="text" name="content" class="form-control" id="message-input" placeholder="Enter message..."
                autocomplete="off">

            <!-- Senden-Button mit eigenem Namen -->
            <button class="btn btn-outline-secondary" type="submit" name="send" value="true">Send</button>

            <!-- Clear-Button mit eigenem Namen -->
            <button class="btn btn-outline-danger" type="submit" name="clear" value="true">Clear</button>
        </form>

    </div>

    <script>
        // Autoscroll to latest message
        window.onload = function () {
            const chatContainer = document.getElementById("chat-container");
            const inputField = document.getElementById("message-input");

            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            if (inputField) {
                inputField.focus()
            }
        };

        // Optional: Focus nach Senden erhalten
        const form = document.getElementById("message-form");
        const input = document.getElementById("message-input");

        if (form && input) {
            form.addEventListener("submit", function () {
                setTimeout(() => { input.focus(); }, 100);
            });
        }
    </script>
    <script>
        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
            localStorage.setItem("dark-mode", document.body.classList.contains("dark-mode"));
        }

        // Zustand aus localStorage laden
        window.onload = function () {
            const chatContainer = document.getElementById("chat-container");
            const inputField = document.getElementById("message-input");

            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            if (inputField) {
                inputField.focus();
            }

            if (localStorage.getItem("dark-mode") === "true") {
                document.body.classList.add("dark-mode");
            }
        };
    </script>
</body>

</html>